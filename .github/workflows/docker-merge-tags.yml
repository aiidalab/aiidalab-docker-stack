name: Download images tags from GitHub artifacts and create multi-platform manifests

env:
  OWNER: ${{ github.repository_owner }}

on:
  workflow_call:
    inputs:
      image:
        description: Image name
        required: true
        type: string

jobs:
  merge-tags:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repo ⚡️
        uses: actions/checkout@v3
      - name: Create dev environment 📦
        uses: ./.github/actions/create-dev-env
        with:
          architecture: amd64

      - name: Download amd64 tags file 📥
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.image }}-amd64-tags
          path: /tmp/
      - name: Download arm64 tags file 📥
        uses: actions/download-artifact@v3
        with:
          name: ${{ inputs.image }}-arm64-tags
          path: /tmp/

      - name: Login to GitHub Container Registry 🔑
        uses: docker/login-action@v2
        with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge tags for the images of different arch 🔀
        run: |
          for arch_tag in $(cat /tmp/${{ inputs.image }}-amd64-tags); do
            tag=$(echo $arch_tag | sed "s/:amd64-/:/")
            docker manifest create ghcr.io/${{ env.OWNER }}/${{ inputs.image }}:$tag ghcr.io/${{ env.OWNER }}/${{ inputs.image }}:amd64-$tag
            docker manifest push ghcr.io/${{ env.OWNER }}/${{ inputs.image }}:$tag
          done

          for arch_tag in $(cat /tmp/${{ inputs.image }}-arm64-tags); do
            tag=$(echo $arch_tag | sed "s/:arm64-/:/")
            docker manifest create ghcr.io/${{ env.OWNER }}/${{ inputs.image }}:$tag ghcr.io/${{ env.OWNER }}/${{ inputs.image }}:arm64-$tag
            docker manifest push ghcr.io/${{ env.OWNER }}/${{ inputs.image }}:$tag
          done
        shell: bash
